me: Release Workflow

on:
          workflow_dispatch: {}

          jobs:
                    release:
                                name: Release v${{ github.run_number }}
                                    runs-on: ubuntu-latest
                                        environment: production

                                            permissions:
                                                          contents: write
                                                                pull-requests: write
                                                                      issues: write

                                                                          env:
                                                                                        REGISTRY_URL: cr.yandex
                                                                                              APP_NAME: app
                                                                                                    PA_REGISTRY_ID: ${{ secrets.PA_REGISTRY_ID }}

                                                                                                        steps:
                                                                                                                      - name: Checkout Repository
                                                                                                                                uses: actions/checkout@v4
                                                                                                                                        with:
                                                                                                                                                          fetch-depth: 0  

                                                                                                                                                                - name: Set up Node.js
                                                                                                                                                                          uses: actions/setup-node@v4
                                                                                                                                                                                  with:
                                                                                                                                                                                                    node-version: 22

                                                                                                                                                                                                          - name: Install Dependencies
                                                                                                                                                                                                                    run: npm ci

                                                                                                                                                                                                                          - name: Run Linter
                                                                                                                                                                                                                                    run: npm run lint

                                                                                                                                                                                                                                          - name: Run Tests
                                                                                                                                                                                                                                                    run: npm run test

                                                                                                                                                                                                                                                          - name: Fetch Tags (debug)
                                                                                                                                                                                                                                                                    run: |
                                                                                                                                                                                                                                                                                      git fetch --tags
                                                                                                                                                                                                                                                                                                git tag

                                                                                                                                                                                                                                                                                                      - name: Get Commit List Since Last Tag
                                                                                                                                                                                                                                                                                                                id: commits
                                                                                                                                                                                                                                                                                                                        run: |
                                                                                                                                                                                                                                                                                                                                          git fetch --tags
                                                                                                                                                                                                                                                                                                                                                    LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo 'initial')

                                                                                                                                                                                                                                                                                                                                                              echo "LAST_TAG: $LAST_TAG"

                                                                                                                                                                                                                                                                                                                                                                        if [ "$LAST_TAG" = "initial" ]; then
                                                                                                                                                                                                                                                                                                                                                                                    if git rev-parse --verify HEAD > /dev/null 2>&1; then
                                                                                                                                                                                                                                                                                                                                                                                                  COMMITS="Initial release"
                                                                                                                                                                                                                                                                                                                                                                                                              else
                                                                                                                                                                                                                                                                                                                                                                                                                            COMMITS="Repository is empty"
                                                                                                                                                                                                                                                                                                                                                                                                                                        fi
                                                                                                                                                                                                                                                                                                                                                                                                                                                  else
                                                                                                                                                                                                                                                                                                                                                                                                                                                              COMMITS=$(git log --pretty=format:"- %s" $LAST_TAG..HEAD)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        fi

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  [ -z "$COMMITS" ] && COMMITS="No new commits"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ESCAPED_COMMITS=$(echo "$COMMITS" | sed -z 's/\n/\\n/g')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      printf 'commits=%s\n' "$ESCAPED_COMMITS" >> $GITHUB_OUTPUT

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - name: Create Release Branch
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        git config --global user.email "github-actions@example.com"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  git config --global user.name "GitHub Actions"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            git checkout -b releases/${{ github.run_number }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      git push origin releases/${{ github.run_number }}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - name: Create Git Tag
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        git tag v${{ github.run_number }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  git push origin v${{ github.run_number }}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - name: Build Docker Image
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    DOCKER_IMAGE_LATEST=${REGISTRY_URL}/${PA_REGISTRY_ID}/${APP_NAME}:${{ github.run_number }}_latest
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              DOCKER_IMAGE_VERSIONED=${REGISTRY_URL}/${PA_REGISTRY_ID}/${APP_NAME}:${{ github.run_number }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        docker build -t $DOCKER_IMAGE_VERSIONED .
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  docker tag $DOCKER_IMAGE_VERSIONED $DOCKER_IMAGE_LATEST

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - name: Authenticate to Yandex Container Registry
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    echo "${{ secrets.PA_OAUTH_TOKEN }}" | docker login --username oauth --password-stdin $REGISTRY_URL

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          - name: Push Docker Images
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      DOCKER_IMAGE_LATEST=${REGISTRY_URL}/${PA_REGISTRY_ID}/${APP_NAME}:${{ github.run_number }}_latest
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                DOCKER_IMAGE_VERSIONED=${REGISTRY_URL}/${PA_REGISTRY_ID}/${APP_NAME}:${{ github.run_number }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          docker push $DOCKER_IMAGE_VERSIONED
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    docker push $DOCKER_IMAGE_LATEST

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          - name: Create Release Issue
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    uses: actions/github-script@v6
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              script: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const lines = process.env.COMMITS ? process.env.COMMITS.split('\\n') : ['No new commits'];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const formatted = lines.join('\n');

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const body = `
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Date: ${new Date().toISOString()}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      Author: ${{ github.actor }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    Version: ${{ github.run_number }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  Docker Image: ${{ env.REGISTRY_URL }}/${{ env.PA_REGISTRY_ID }}/${{ env.APP_NAME }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Commits since last release:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ${formatted}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  `;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              github.rest.issues.create({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    owner: context.repo.owner,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  repo: context.repo.repo,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                title: "Release v${{ github.run_number }}",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              body: body
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  env:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    COMMITS: ${{ steps.commits.outputs.commits }}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          - name: Update CHANGELOG.md
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    id: changelog
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            env:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ESCAPED_COMMITS: ${{ steps.commits.outputs.commits }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        NEW_ENTRY="## v${{ github.run_number }}\n$(date '+%Y-%m-%d')\n$ESCAPED_COMMITS\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  NEW_ENTRY=$(echo "$NEW_ENTRY" | sed 's/\\n/\n/g')

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            git checkout -b update-changelog/v${{ github.run_number }}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if [ -f CHANGELOG.md ]; then
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if ! grep -q "v${{ github.run_number }}" CHANGELOG.md; then
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                echo "$NEW_ENTRY" | cat - CHANGELOG.md > temp && mv temp CHANGELOG.md
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          exit 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      fi
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            echo "$NEW_ENTRY" > CHANGELOG.md
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      fi

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                git add CHANGELOG.md
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          git config --global user.email "github-actions@example.com"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    git config --global user.name "GitHub Actions"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              git commit -m "docs: обновление CHANGELOG для v${{ github.run_number }}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        git push origin update-changelog/v${{ github.run_number }} --force

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  echo "changelog_branch=update-changelog/v${{ github.run_number }}" >> $GITHUB_OUTPUT

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - name: Open Pull Request for CHANGELOG
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  uses: actions/github-script@v6
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            script: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                await github.rest.pulls.create({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      owner: context.repo.owner,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    repo: context.repo.repo,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  title: "docs: обновление CHANGELOG для v${{ github.run_number }}",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                head: "${{ steps.changelog.outputs.changelog_branch }}",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              base: "main",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            body: "Auto-generated CHANGELOG update for release v${{ github.run_number }}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              - name: Wait before merge
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        run: sleep 5

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              - name: Merge CHANGELOG Pull Request
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        env:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          GH_TKN: ${{ secrets.GH_PAT }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    gh auth login --with-token <<< "$GH_TKN"

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              PR_NUMBER=$(gh pr list --head update-changelog/v${{ github.run_number }} --json number --jq '.[0].number')

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        gh pr merge $PR_NUMBER --merge --admin --delete-branch
